require 'rubygems'
require 'active_record'

connection = {
  :adapter => 'mysql',
  :host => 'localhost',
  :username => 'root',
  :password => '',
  :database => 'hondana',
  :encoding => 'utf8'
}

ActiveRecord::Base.establish_connection(connection)

class Book < ActiveRecord::Base
  has_many :entries
  has_many :shelves, :through => :entries
end

class Shelf < ActiveRecord::Base
  has_many :entries
  has_many :books, :through => :entries
end

class Entry < ActiveRecord::Base
  belongs_to :book
  belongs_to :shelf
end

shelfbooks = {}
shelves = Shelf.find(:all)
shelfnames = shelves.collect { |shelf|
  shelf.name
}

ActiveRecord::Base.remove_connection

count = 0
shelfnames.each { |shelfname|
  next if shelfname =~ /deleted/
  STDERR.puts "#{count} #{shelfname}"
  count += 1
  isbns = []
  ActiveRecord::Base.establish_connection(connection)

  shelf = Shelf.find(:first, :conditions => ["name = ?", shelfname])

#  books = shelf.books
#  books.each { |book|
#    isbns << book.isbn
#  }
# 

  if shelf then
    isbns = shelf.books.collect { |book|
      book.isbn
    }
#  puts "shelfbooks['#{shelf.name}'] =['" + data.join("', '") + "']"

    shelfbooks[shelfname] = isbns
  end

  ActiveRecord::Base.remove_connection
}

STDERR.puts "Writing to marshal.shelfbooks ..."
File.open("marshal.shelfbooks","w"){ |f|
  f.print Marshal.dump(shelfbooks)
}
